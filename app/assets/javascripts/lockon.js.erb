var browserSupportFlag =  new Boolean();
var map;
var confirmWindow;
var infowindow;
//var pointData=new Array();
var index=2;
var user_id;
var trip_id=-1;
var trip_name;
var trip_date;
var deleteList=new Array();
var lockmap=0;
var zoom_s=true;
var animateOn=true;
var w_height;
var editTarget_id;
var edit_s=false;
var edit_menu_id=-1;
var tmpArray;
var openPopUi=0;
var back=true;
var keyboard_s=false;
var tripPointList;

//初始化
function initialize() {

	//載入widget
	tripPointList=new TripPointListbarModule('#trip_one');
	
	tripPointEdit = new TripPointEditModule('#add_new');
	
	TripListbar.init_trip_listbar('#trip_list');
	
	//依照解析度調整布局
	reLayout(); 
	$(window).bind('resize',function(){
		reLayout();
	});

	//初始化地圖
	var latlng = new google.maps.LatLng(23.80, 121.500);
  	var myOptions = {
		mapTypeControl:false, 
		streetViewControl:false,
		zoom: 8,
		minZoom: 2,
		zoomControl:true,
		zoomControlOptions:{	style: google.maps.ZoomControlStyle.DEFAULT ,
								position:google.maps.ControlPosition.LEFT_TOP},
		panControl:false, 
		mapTypeControl:true,
		mapTypeControlOptions: {style: google.maps.MapTypeControlStyle.DEFAULT ,
								position: google.maps.ControlPosition.TOP_LEFT  },
		mapTypeId: google.maps.MapTypeId.TERRAIN,
		keyboardShortcuts: false
	};
	map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
	map.setCenter(latlng);
		
	

	//初始環境變數
	//resetEnv();		 
	
	$('#share').click(function(){
		$('.popup #shareInput').val('http://www.wanderworld.com.tw/'+trip_id).select();
	});
	////////待整理//////////////////	
	
	// 文字編輯器初始化
	var config = { 
		skin : 'kama2',
		height : '100%',
		removePlugins : 'elementspath',
		toolbar : [	[ 'Undo','Redo' ],
					[ 'Bold','Italic','Underline', '-' ,'JustifyLeft','JustifyCenter','JustifyRight', '-' ,'NumberedList','BulletedList', 'RemoveFormat'  ] ,
					[ 'Link','Unlink' ],
					'/' , 
					[ 'Font','FontSize', 'Templates' ],
					[ 'TextColor' , 'BGColor' ],
					[ 'Image' , 'HorizontalRule' ,'Maximize']
				]
	};
	CKEDITOR.replace('editPost', config);

	$( "#aboutme_editor" ).draggable({ containment: "#aboutme_all" ,handle:'#headDiv' });
	$( "#aboutme_main" ).draggable({ containment: "#aboutme_all" });
	$( "#tabs" ).tabs();
	configAboutMe();
	$( "#map_small" ).resizable({
		handles: "nw",
		aspectRatio: 260 / 200
	});
	
	TripListbar.timeline();	
	$("#slidesContainer").draggable({ containment: "#map_canvas" ,handle:'#move_this' ,axis: "x"  });
	search_name();
	
	////////////////////////////////
	
	var opts,target,spinner;
	opts = {
		lines: 13, // The number of lines to draw
		length: 7, // The length of each line
		width: 4, // The line thickness
		radius: 10, // The radius of the inner circle
		rotate: 0, // The rotation offset
		color: '#000', // #rgb or #rrggbb
		speed: 1.6, // Rounds per second
		trail: 60, // Afterglow percentage
		shadow: false, // Whether to render a shadow
		hwaccel: false, // Whether to use hardware acceleration
		className: 'spinner', // The CSS class to assign to the spinner
		zIndex: 2e9, // The z-index (defaults to 2000000000)
		top: 'auto', // Top position relative to parent in px
		left: 'auto' // Left position relative to parent in px
	};
	target = document.getElementById('foo');
	spinner = new Spinner(opts).spin(target);	
	opts = {
		lines: 11, // The number of lines to draw
		length: 3, // The length of each line
		width: 2, // The line thickness
		radius: 4, // The radius of the inner circle
		rotate: 0, // The rotation offset
		color: '#000', // #rgb or #rrggbb
		speed: 2.0, // Rounds per second
		trail: 100, // Afterglow percentage
		shadow: false, // Whether to render a shadow
		hwaccel: false, // Whether to use hardware acceleration
		className: 'spinner', // The CSS class to assign to the spinner
		zIndex: 2e9, // The z-index (defaults to 2000000000)
		top: '12px', // Top position relative to parent in px
		left: '11px' // Left position relative to parent in px
	};
	target = document.getElementById('newTripLoad');
	spinner = new Spinner(opts).spin(target);	
	

}

//重新建構pointData  用新的index編排
function reIndex(){
	var point=$('.point');
	var tmp_pointData=new Array();
	for(i=0;i<point.length;i++){
		var tmp=$(point[i]).parent().attr('value');
		tmp_pointData[i]=pointData[tmp];
		$(point[i]).parent().attr('value',i);
	}
	pointData=tmp_pointData;
}



//初始環境
function resetEnv(){
/*	var i;
	for(i=0;i<pointData.length;i++)
		deleteMark(i);
	pointData=new Array();
	$('#trip_name a:eq(0)').text('');
	$('#trip_date a:eq(0)').text('');
	$('#trip_name div').unbind('click');
	$('#trip_date div').unbind('click');
	$('#trip_status').hide();
	$('.trip_point_group').remove();
	index=0;
	deleteList=new Array();
	editTarget_id=-1;
	closePost();
*/
}
//因應解析度重新布局
function reLayout(){
	var main_h=$(window).height()-$('.header').height();	
    $('.main_content').css('height', main_h);
	$('#main_control').css('height', main_h-40);
	$('#map_canvas').css('width',$(document).width()-130 );
	$('#timeline').css('height', $('.list').height()-130);
	//景點區高度
	var other_h = ($('.trip_information').height()+30) + $('.add_group_title').height() + ($('#view_num').height()+30);
	if(other_h+($('.trip_point_all').height()+30) > $('.list').height()){
		$('.scroll-pane').css('height', $('.list').height()-other_h-30);
	}
	else{
		$('.scroll-pane').css('height', $('.trip_point_all').height());
	}
	//遊記框高度
	if(bounce_s){
		$('#bounce').hide();
		$('#collapse').show();		
		$('#slidesContainer').css('height',$(document).height()-$('.header').height());
		$('#slide_main').css('height',$(document).height()-$('.header').height()-40);
		$('.cke_editor').css('height',$(document).height()-$('.header').height()-40-15);
		$('.control').css('line-height', $(document).height()-$('.header').height()-40 +'px');
		$('#foo').css('top',$('#journal').height()/2+30);
	}
	//遊記框位置
	var Container_r = 260 + ($(document).width()- 1280)/2  ;
	$('#slidesContainer').css('right',Container_r);
	$('#slidesContainer_s').css('right',Container_r);	
	
	if(map_flag==true)
		computeMap();
	//lookingAround
	var wrap_h;
	if($(window).height()-$('.header').height() < $('.main_block').height()+20){
			wrap_h=$('.main_block').height()+20;
	}else{
			wrap_h=$(window).height()-$('.header').height();
	}
	$('.wrap').css('height', wrap_h);
	$('.friend_block').css('height',$(window).height()-$('.header').height()-68 );
	$('.friend_all').css('height',$(window).height()-$('.header').height()-102 );
}

//*/

//檢測位置
function detectLocation(){

  if(navigator.geolocation) {
    browserSupportFlag = true;
    navigator.geolocation.getCurrentPosition(function(position) {
      var initialLocation = new google.maps.LatLng(position.coords.latitude,position.coords.longitude);
      map.setCenter(initialLocation);
       
	marker=new google.maps.Marker({
		position: initialLocation,
		map: map
	});
	marker.setMap(map);
    }, function() {
      handleNoGeolocation(browserSupportFlag);
    });
  }else {
    browserSupportFlag = false;
    handleNoGeolocation(browserSupportFlag);
  }
  
  function handleNoGeolocation(errorFlag) {
    if (errorFlag == true) {
      alert("Geolocation service failed.");
    } else {
      alert("Your browser doesn't support geolocation. We've placed you in Siberia.");
    }
  }
}
