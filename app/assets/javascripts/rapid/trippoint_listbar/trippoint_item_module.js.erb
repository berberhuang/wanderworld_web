var TrippointItemModule=function(obj){
	var target=obj;
	
	var groupItemManager;
	
	//設定當前所在 景點列表
	var setTripPointList=function(tpList){
		for(i=0;i<tpList.length;i++){
			insertTripPoint(tpList[i].id,tpList[i].group_id,tpList[i].sort_id,tpList[i].place.name,tpList[i].place.latitude, tpList[i].place.longitude);
		}
	};
	
	//加入景點
	var insertTripPoint=function(i,group_id, sort_id,title, lat, lng){
		str='';
		str+='<li>'
		
		str+='<div class="point"';
		str+=' data-id="'+i+'"';
		str+=' data-sort_id"'+sort_id+'"';
		str+=' data-latitude="'+lat+'"';
		str+=' data-longitude="'+lng+'"';
		str+='>';						
		
		str+='<img class="point_mark" />';
		str+='<a class="point_name">'+title+'</a>';
		str+='<div class="point_edit"></div>';
		str+='<div style="clear: both;display: block"></div>';
		str+='</div>';
		str+='</li>';
		
		var item=$(str).appendTo(target.find('#trip_point_group_'+group_id+' ul'));
		//		.find('.point_name').click(function(event){
		//			contentBox.cancelEditWarning(group_id,function(){
		//				var item=$(event.target);
		//				var id=item.parents('li').val();
						
		//				selectTripPointEffect(item);

		//				clickPointTitle(item.parents('.trip_point_group').attr('id').split('_group_')[1],id);
		//				showingGroup=group_id;
		//			});
		//		}).end();
		
		if(DataStatus.isOwner){
			ownerModeEnable(item);
		}
	};
	
	var ownerModeEnable=function(item){
		var str='<img src="/assets/settings.png" title="編輯"></img>';
		item.find('.point_edit').append(str)
			.find('img').click(editPoint);;
	};

	//按下景點名稱
	var clickPointTitle=function(group_id,id){
		if(showingGroup!=group_id){
			var tmp=[];
			var tpList=DataStatus.tripPointList;
			for(var i=0; i<tpList.length;i++){
				if(tpList[i].group_id==group_id){
					tmp.push(tpList[i]);
				}
			}
			
			computeMap(tmp);
			
		}

		if(contentBox.isShow()&&showingGroup==group_id){
			//PathOnMap.showMarkInfo(id);
			contentBox.UiControl.showContent(group_id,id);
		}else{
			contentBox.UiControl.hide(true);
			contentBox.reset();
								
			document.title='WanderWorld地球漫遊 - '+DataStatus.trip_name;
			window.history.pushState(null,document.title,'/'+DataStatus.trip_id);
			
			PathOnMap.showMarkInfo(id);
		}
		
		tripPointEdit.UiListener.confirmCancel();
		
		showingGroup=group_id;
	};
	
	//點選景點得視覺效果
	var selectTripPointEffect=function(item){
		unselectTripPointEffect();
		//moduleInstance.UiControl.selectGroup(item.parents('.trip_point_group'));
		item.parent().addClass('trip_point_selected');
	};
	//取消鎖定景點的效果
	var unselectTripPointEffect=function(){
		show_id=null
		target.find('.trip_point_selected').removeClass('trip_point_selected');
	};
	
	//編輯景點(click)menu
	var editPoint=function(event){	
		var item=$(event.target).parents('li');
		var id=item.val();
		var group_id=item.parents('.trip_point_group').attr('id').split('_group_')[1];
		edit_menu_id=id;
		var x=item.offset().left;
		var y=item.offset().top;
		//var menu=item.parent().css('display','block').find('.point_edit_menu').show();	
		
		var str='';
		str+='<div class="point_edit_menu">';
		str+='<div id="editPostContent"><img src="/assets/pencil.png">編輯遊記</div>';
		str+='<div id="removeTripPoint"><img src="/assets/delete1.png">刪除景點</div>';
		str+='</div>';	
		
		var menu=$(str).appendTo('#trip_one').show().css('position','absolute').offset({left:x+115,top:y+20});
		
		menu.find('#removeTripPoint').click(function(){
					removePoint(id);
					menu.unbind('clickoutside');
					menu.unbind('mouseleave');
					menu.remove();
				}).end()
			.find('#editPostContent').click(function(){
					contentBox.cancelEditWarning(group_id,function(){
						contentBox.clickEditPost(group_id,id);	
						showingGroup=group_id;
					});
					menu.unbind('clickoutside');
					menu.unbind('mouseleave');
					menu.remove();
				}).end();
		
		setTimeout(function(){
			menu.bind('clickoutside',function(){
				menu.unbind('clickoutside');
				menu.unbind('mouseleave');
				menu.remove();
			});
			menu.bind('mouseleave',function(){
				menu.unbind('clickoutside').css('display','');
				menu.unbind('mouseleave');
				menu.remove();
			});
		},50);		
	};
	
	
	
	//移除景點
	var removePoint=function(item_id){
		$('.trip_point_all li[value='+item_id+']').remove();
		//PathOnMap.deleteMark(item_id);
		Data.deleteTripPoint(item_id);
		var tpList=DataStatus.tripPointList;
		for(var i=0; i<tpList.length; i++){
			if(tpList[i].id==item_id){
				contentBox.deleteTripPoint(tpList[i].group_id,item_id);
				tpList[i]=null;
				break;
			}
		}
		
		DataStatus.tripPointList=[];
		for(var i=0; i<tpList.length; i++){
			if(tpList[i]){
				DataStatus.tripPointList.push(tpList[i]);
			}
		}
		
		updateMark();
		
		PathOnMap.updateMark();
		PathOnMap.redrawLine();
								
		reLayout();
	};
	
	//在增加景點框按enter(keydown)
	var enterTripPoint=function(event,group_id,item){
		target.find("#newTripPoint").unbind("clickoutside");
		if(event.keyCode==13||event.type=='click'){
			var item_id=$(event.target).parent().val();
			
			addItem(group_id,item);			
			contentBox.UiControl.hideContent();					
		}
	};
	
	//定位新的景點並加入
	var addItem=function(group_id,item){
		var str=item.val();
		var box=str.split(",");
		var name=box[0];
		var city= box[1] ? box[1] : '';
		
		tripPointEdit.setNewTripPointInput(item);
		tripPointEdit.findTripPointByName(name, city, group_id, getNewTripPoint_sort_id(group_id));
	};
	
	var getNewTripPoint_sort_id=function(group_id){
		
		//input所在group內中的最大sort_id
		var lowbound=null;
		
		var tripPointList = $('.point');
		var tplen=tripPointList.length;
		
		//找尋input所在group內中的最大sort_id
		for(var i=0; i<tplen; i++){
			if(tripPointList[i].group_id==group_id){
				if(lowbound == null || tripPointList[i].sort_id > lowbound){
					lowbound = tripPointList[i].sort_id;
				}
			}
		}
		
		if(lowbound==null){
			return 0;
		}else{
			return lowbound+1;
		}
	};

	var updateMark=function(){
		var groupList=DataStatus.groupList;
		var plist = target.find('.point_mark');
		for(var i=0; i<plist.length; i++){
			var t=plist.eq(i);
			t.attr('src',getMarkURL(i+1,getGroupColor(t.parents('.trip_point_group').data('id'))));
		}
	};
	
	return {
		init:function(){
			console.log('裝載tripPointList');
			var tripPointPane=target.find('#trip_point_list').addClass('scroll-pane')
		},
		initJavascript:function(){
			var a=$('.point');
			for(var i=0; i<a.length; i++){
				ownerModeEnable(a.eq(i));
			}
			updateMark();
		},
		refresh:function(pointList){
			setTripPointList(pointList);
			updateMark();
		},
		updateMark:function(){
			updateMark();
		},
		setGroupItemManager:function(gim){
			groupItemManager=gim;
		},
		addNewTripPoint:function(event,group_id,item){
			enterTripPoint(event,group_id,item);
		},
		insertTripPoint:function(i,group_id,title){
			insertTripPoint(i,group_id,title);
		}
	};
};